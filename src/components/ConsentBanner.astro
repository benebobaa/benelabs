---
const posthogKey = import.meta.env.PUBLIC_POSTHOG_KEY;
const consentRequired = (import.meta.env.PUBLIC_POSTHOG_CONSENT_REQUIRED ?? 'true') === 'true';
---

{posthogKey && consentRequired ? (
  <div
    id="consent-banner"
    class="site-container fixed bottom-5 left-0 right-0 z-50 hidden"
    data-consent-banner
  >
    <div class="card-surface flex flex-col gap-4 p-5 md:flex-row md:items-center md:justify-between">
      <div class="space-y-2 text-sm text-[var(--color-ink-muted)]">
        <div class="text-sm font-semibold text-[var(--color-ink)]">Analytics preferences</div>
        <p>
          We use PostHog to understand engagement and improve conversions. Session replay is off by default and
          only enabled on selected pages if you consent.
        </p>
      </div>
      <div class="flex flex-wrap gap-3">
        <button class="button-ghost" type="button" data-consent="deny">Decline</button>
        <button class="button-primary" type="button" data-consent="accept">Accept</button>
      </div>
    </div>
  </div>
  <script>
    const banner = document.querySelector('[data-consent-banner]');
    const CONSENT_KEY = 'posthog_consent';

    const getConsent = () => {
      if (typeof localStorage === 'undefined') return null;
      return localStorage.getItem(CONSENT_KEY);
    };

    const setConsent = (value) => {
      if (typeof localStorage === 'undefined') return;
      localStorage.setItem(CONSENT_KEY, value);
    };

    const updateBanner = () => {
      if (!banner) return;
      const value = getConsent();
      banner.classList.toggle('hidden', value === 'granted' || value === 'denied');
    };

    updateBanner();

    banner?.addEventListener('click', (event) => {
      const target = event.target;
      if (!(target instanceof Element)) return;
      const choice = target.getAttribute('data-consent');
      if (!choice) return;
      if (choice === 'accept') {
        setConsent('granted');
        document.dispatchEvent(new CustomEvent('posthog:consent', { detail: 'granted' }));
      }
      if (choice === 'deny') {
        setConsent('denied');
        document.dispatchEvent(new CustomEvent('posthog:consent', { detail: 'denied' }));
      }
      updateBanner();
    });
  </script>
) : null}
