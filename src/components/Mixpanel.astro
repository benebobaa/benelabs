---
const mixpanelToken = import.meta.env.PUBLIC_MIXPANEL_TOKEN;
---

{mixpanelToken ? (
  <script>
    const getUtmParams = () => {
      const params = new URLSearchParams(window.location.search);
      const keys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'gclid', 'fbclid'];
      return keys.reduce((acc, key) => {
        const value = params.get(key);
        if (value) acc[key] = value;
        return acc;
      }, {});
    };

    const withPrefix = (prefix, obj) =>
      Object.keys(obj).reduce((acc, key) => {
        acc[`${prefix}${key}`] = obj[key];
        return acc;
      }, {});

    const getContentContext = (node) => {
      const container = node?.closest?.('[data-analytics-content]');
      if (!container) return {};
      return {
        type: container.getAttribute('data-analytics-content'),
        slug: container.getAttribute('data-analytics-slug'),
        title: container.getAttribute('data-analytics-title'),
      };
    };

    const setDistinctId = (mp) => {
      if (!mp?.get_distinct_id) return;
      const distinctId = mp.get_distinct_id();
      if (!distinctId) return;
      window.__mixpanelDistinctId = distinctId;
      document.dispatchEvent(new CustomEvent('mixpanel:ready', { detail: { distinctId } }));
    };

    const loadMixpanel = async () => {
      if (mixpanel) return mixpanel;
      const module = await import('mixpanel-browser');
      mixpanel = module.default;
      return mixpanel;
    };

    const MIXPANEL_TOKEN = import.meta.env.PUBLIC_MIXPANEL_TOKEN;
    const MIXPANEL_API_HOST = import.meta.env.PUBLIC_MIXPANEL_API_HOST || 'https://api.mixpanel.com';
    const AUTOCAPTURE_ENABLED = (import.meta.env.PUBLIC_MIXPANEL_AUTOCAPTURE || 'false') === 'true';
    const TRACK_PAGEVIEW = (import.meta.env.PUBLIC_MIXPANEL_TRACK_PAGEVIEW || 'false') === 'true';
    const SESSION_REPLAY_ENABLED = (import.meta.env.PUBLIC_MIXPANEL_SESSION_REPLAY || 'false') === 'true';
    const SESSION_REPLAY_PERCENT = Number.parseInt(
      import.meta.env.PUBLIC_MIXPANEL_SESSION_REPLAY_PERCENT || '0',
      10
    );
    let mixpanel;

    const isDebug = () => {
      if (typeof window === 'undefined') return false;
      return new URLSearchParams(window.location.search).has('debug_mixpanel');
    };

    const log = (...args) => {
      if (isDebug()) {
        console.log('[Mixpanel Debug]', ...args);
      }
    };

    const getReplayPercent = (allowReplay) => {
      if (!allowReplay) return 0;
      const percent = Number.isFinite(SESSION_REPLAY_PERCENT) ? SESSION_REPLAY_PERCENT : 0;
      return Math.min(Math.max(percent, 0), 100);
    };

    const initMixpanel = async () => {
      if (!MIXPANEL_TOKEN || window.__mixpanelInitialized) return;
      window.__mixpanelInitialized = true;

      try {
        const mp = await loadMixpanel();
        if (!mp) return;

        const allowReplay =
          SESSION_REPLAY_ENABLED && document.body.getAttribute('data-session-replay') === 'true';
        const replayPercent = getReplayPercent(allowReplay);

        mp.init(MIXPANEL_TOKEN, {
          api_host: MIXPANEL_API_HOST,
          autocapture: AUTOCAPTURE_ENABLED,
          track_pageview: TRACK_PAGEVIEW,
          persistence: 'localStorage',
          record_sessions_percent: replayPercent,
          record_heatmap_data: allowReplay && replayPercent > 0,
          debug: isDebug(),
        });

        window.mixpanel = mp;
        setDistinctId(mp);
        log('Mixpanel initialized', { host: MIXPANEL_API_HOST });

        mp.register_once({ landing_path: window.location.pathname });
        if (document.referrer) {
          mp.register_once({ landing_referrer: document.referrer });
        }

        const utms = getUtmParams();
        if (Object.keys(utms).length) {
          mp.register(utms);
          mp.register_once(withPrefix('first_touch_', utms));
          mp.people?.set(utms);
          mp.people?.set_once(withPrefix('first_touch_', utms));
        }

        mp.track('page_view', {
          path: window.location.pathname,
          title: document.title,
          referrer: document.referrer,
        });

        const listNodes = document.querySelectorAll('[data-analytics-list]');
        listNodes.forEach((listNode) => {
          mp.track('content_list_view', {
            list: listNode.getAttribute('data-analytics-list'),
          });
        });

        const contentNode = document.querySelector('[data-analytics-content]');
        if (contentNode) {
          mp.track('content_view', {
            type: contentNode.getAttribute('data-analytics-content'),
            slug: contentNode.getAttribute('data-analytics-slug'),
            title: contentNode.getAttribute('data-analytics-title'),
          });

          const article = contentNode;
          let engaged = false;
          let completed = false;
          const handler = () => {
            const rect = article.getBoundingClientRect();
            const height = rect.height || 1;
            const progress = Math.min(Math.max((window.innerHeight - rect.top) / height, 0), 1);
            if (!engaged && progress >= 0.5) {
              engaged = true;
              mp.track('content_engaged', {
                type: contentNode.getAttribute('data-analytics-content'),
                slug: contentNode.getAttribute('data-analytics-slug'),
                title: contentNode.getAttribute('data-analytics-title'),
                scroll: '50',
              });
            }
            if (!completed && progress >= 0.9) {
              completed = true;
              mp.track('content_completed', {
                type: contentNode.getAttribute('data-analytics-content'),
                slug: contentNode.getAttribute('data-analytics-slug'),
                title: contentNode.getAttribute('data-analytics-title'),
                scroll: '90',
              });
            }
            if (engaged && completed) {
              window.removeEventListener('scroll', handler);
            }
          };
          window.addEventListener('scroll', handler, { passive: true });
          handler();
        }

        document.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof Element)) return;

          const analyticsNode = target.closest('[data-analytics]');
          if (analyticsNode) {
            const type = analyticsNode.getAttribute('data-analytics');
            const label = analyticsNode.getAttribute('data-label') ?? analyticsNode.textContent?.trim();
            if (type === 'cta') {
              mp.track('cta_click', { label, href: analyticsNode.getAttribute('href') });
            }
            if (type === 'nav') {
              mp.track('nav_click', { label, href: analyticsNode.getAttribute('href') });
            }
            if (type === 'email') {
              mp.track('contact_email_click', { href: analyticsNode.getAttribute('href') });
            }
            if (type === 'project-link') {
              mp.track('project_link_click', { label, href: analyticsNode.getAttribute('href') });
            }
            if (type === 'project-video') {
              mp.track('project_video_play', {
                label,
                href: analyticsNode.getAttribute('href'),
                ...getContentContext(analyticsNode),
              });
            }
          }

          const anchor = target.closest('a');
          if (anchor && anchor.hostname && anchor.hostname !== window.location.hostname) {
            mp.track('outbound_link_click', {
              href: anchor.href,
              label: anchor.textContent?.trim(),
            });
          }
        });

        const form = document.querySelector('[data-analytics-form="contact"]');
        if (form instanceof HTMLFormElement) {
          const formName = form.getAttribute('data-analytics-form') ?? 'contact';
          let started = false;
          form.addEventListener('focusin', () => {
            if (started) return;
            started = true;
            mp.track('contact_form_start', { form: formName });
          });
          form.addEventListener('submit', () => {
            mp.track('contact_form_submit', { form: formName });
          });
        }

        const videoNodes = document.querySelectorAll('[data-analytics-video]');
        videoNodes.forEach((node) => {
          if (!(node instanceof HTMLVideoElement)) return;
          const type = node.getAttribute('data-analytics-video');
          node.addEventListener(
            'play',
            () => {
              mp.track('project_video_play', { type, ...getContentContext(node) });
            },
            { once: true }
          );
        });

        mp.register({ session_replay_enabled: allowReplay });
      } catch (err) {
        log('Error initializing Mixpanel', err);
      }
    };

    initMixpanel();
  </script>
) : null}
