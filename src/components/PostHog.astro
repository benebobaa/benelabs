---
const posthogKey = import.meta.env.PUBLIC_POSTHOG_KEY;
---

{posthogKey ? (
  <script>
    const POSTHOG_KEY = import.meta.env.PUBLIC_POSTHOG_KEY;
    const POSTHOG_HOST = import.meta.env.PUBLIC_POSTHOG_HOST || 'https://app.posthog.com';
    const CONSENT_REQUIRED = (import.meta.env.PUBLIC_POSTHOG_CONSENT_REQUIRED || 'true') === 'true';
    const SESSION_REPLAY_ENABLED = (import.meta.env.PUBLIC_POSTHOG_SESSION_REPLAY || 'false') === 'true';
    const CONSENT_KEY = 'posthog_consent';
    let posthog;

    const getConsent = () => {
      if (typeof localStorage === 'undefined') return null;
      return localStorage.getItem(CONSENT_KEY);
    };

    const setConsent = (value) => {
      if (typeof localStorage === 'undefined') return;
      localStorage.setItem(CONSENT_KEY, value);
    };

    const getUtmParams = () => {
      const params = new URLSearchParams(window.location.search);
      const keys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'gclid', 'fbclid'];
      return keys.reduce((acc, key) => {
        const value = params.get(key);
        if (value) acc[key] = value;
        return acc;
      }, {});
    };

    const withPrefix = (prefix, obj) =>
      Object.keys(obj).reduce((acc, key) => {
        acc[`${prefix}${key}`] = obj[key];
        return acc;
      }, {});

    const loadPosthog = async () => {
      if (posthog) return posthog;
      const module = await import('posthog-js');
      posthog = module.default;
      return posthog;
    };

    const initPosthog = async () => {
      if (!POSTHOG_KEY || window.__posthogInitialized) return;
      window.__posthogInitialized = true;
      const ph = await loadPosthog();
      ph.init(POSTHOG_KEY, {
        api_host: POSTHOG_HOST,
        autocapture: false,
        capture_pageview: false,
        capture_pageleave: false,
        disable_session_recording: true,
      });

      ph.opt_in_capturing();

      const utms = getUtmParams();
      if (Object.keys(utms).length) {
        ph.register(utms);
        ph.register_once(withPrefix('first_touch_', utms));
        ph.people.set(utms);
        ph.people.set_once(withPrefix('first_touch_', utms));
      }

      ph.capture('page_view', {
        path: window.location.pathname,
        title: document.title,
        referrer: document.referrer,
      });

      const listNode = document.querySelector('[data-analytics-list]');
      if (listNode) {
        ph.capture('content_list_view', {
          list: listNode.getAttribute('data-analytics-list'),
        });
      }

      const contentNode = document.querySelector('[data-analytics-content]');
      if (contentNode) {
        ph.capture('content_view', {
          type: contentNode.getAttribute('data-analytics-content'),
          slug: contentNode.getAttribute('data-analytics-slug'),
          title: contentNode.getAttribute('data-analytics-title'),
        });

        const article = contentNode;
        const handler = () => {
          const rect = article.getBoundingClientRect();
          const height = rect.height || 1;
          const progress = Math.min(Math.max((window.innerHeight - rect.top) / height, 0), 1);
          if (progress >= 0.5) {
            ph.capture('content_engaged', {
              type: contentNode.getAttribute('data-analytics-content'),
              slug: contentNode.getAttribute('data-analytics-slug'),
              title: contentNode.getAttribute('data-analytics-title'),
              scroll: '50',
            });
            window.removeEventListener('scroll', handler);
          }
        };
        window.addEventListener('scroll', handler, { passive: true });
        handler();
      }

      document.addEventListener('click', (event) => {
        const target = event.target;
        if (!(target instanceof Element)) return;

        const analyticsNode = target.closest('[data-analytics]');
        if (analyticsNode) {
          const type = analyticsNode.getAttribute('data-analytics');
          const label = analyticsNode.getAttribute('data-label') ?? analyticsNode.textContent?.trim();
          if (type === 'cta') {
            ph.capture('cta_click', { label, href: analyticsNode.getAttribute('href') });
          }
          if (type === 'nav') {
            ph.capture('nav_click', { label, href: analyticsNode.getAttribute('href') });
          }
          if (type === 'email') {
            ph.capture('contact_email_click', { href: analyticsNode.getAttribute('href') });
          }
          if (type === 'contact-submit') {
            ph.capture('contact_form_submit', { label: label ?? 'Send message' });
          }
          if (type === 'project-link') {
            ph.capture('project_link_click', { label, href: analyticsNode.getAttribute('href') });
          }
        }

        const anchor = target.closest('a');
        if (anchor && anchor.hostname && anchor.hostname !== window.location.hostname) {
          ph.capture('outbound_link_click', {
            href: anchor.href,
            label: anchor.textContent?.trim(),
          });
        }
      });

      const allowReplay =
        SESSION_REPLAY_ENABLED && document.body.getAttribute('data-session-replay') === 'true';
      if (allowReplay) {
        ph.startSessionRecording?.();
      } else {
        ph.stopSessionRecording?.();
      }
    };

    const handleConsent = (state) => {
      if (!CONSENT_REQUIRED) {
        initPosthog();
        return;
      }
      if (state === 'granted') {
        setConsent('granted');
        initPosthog();
      } else if (state === 'denied') {
        setConsent('denied');
        if (posthog) {
          posthog.opt_out_capturing();
          posthog.stopSessionRecording?.();
        }
      }
    };

    document.addEventListener('posthog:consent', (event) => {
      handleConsent(event.detail);
    });

    if (!CONSENT_REQUIRED || getConsent() === 'granted') {
      initPosthog();
    }
  </script>
) : null}
