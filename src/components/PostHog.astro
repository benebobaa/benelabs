---
const posthogKey = import.meta.env.PUBLIC_POSTHOG_KEY;
---

{posthogKey ? (
  <script>
    const POSTHOG_KEY = import.meta.env.PUBLIC_POSTHOG_KEY;
    const SESSION_REPLAY_ENABLED = (import.meta.env.PUBLIC_POSTHOG_SESSION_REPLAY || 'false') === 'true';
    const AUTOCAPTURE_ENABLED = (import.meta.env.PUBLIC_POSTHOG_AUTOCAPTURE || 'true') === 'true';
    let posthog;

    const getUtmParams = () => {
      const params = new URLSearchParams(window.location.search);
      const keys = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'gclid', 'fbclid'];
      return keys.reduce((acc, key) => {
        const value = params.get(key);
        if (value) acc[key] = value;
        return acc;
      }, {});
    };

    const withPrefix = (prefix, obj) =>
      Object.keys(obj).reduce((acc, key) => {
        acc[`${prefix}${key}`] = obj[key];
        return acc;
      }, {});

    const getContentContext = (node) => {
      const container = node?.closest?.('[data-analytics-content]');
      if (!container) return {};
      return {
        type: container.getAttribute('data-analytics-content'),
        slug: container.getAttribute('data-analytics-slug'),
        title: container.getAttribute('data-analytics-title'),
      };
    };

    const setDistinctId = (ph) => {
      if (!ph?.get_distinct_id) return;
      const distinctId = ph.get_distinct_id();
      if (!distinctId) return;
      window.__posthogDistinctId = distinctId;
      document.dispatchEvent(new CustomEvent('posthog:ready', { detail: { distinctId } }));
    };

    const loadPosthog = async () => {
      if (posthog) return posthog;
      const module = await import('posthog-js');
      posthog = module.default;
      return posthog;
    };

    const isDebug = () => {
      if (typeof window === 'undefined') return false;
      return new URLSearchParams(window.location.search).has('debug_posthog');
    };

    const log = (...args) => {
      if (isDebug()) {
        console.log('[PostHog Debug]', ...args);
      }
    };

    const initPosthog = async () => {
      if (!POSTHOG_KEY || window.__posthogInitialized) return;
      window.__posthogInitialized = true;
      
      try {
        const ph = await loadPosthog();
        if (!ph) return;

        ph.init(POSTHOG_KEY, {
          api_host: POSTHOG_HOST,
          autocapture: AUTOCAPTURE_ENABLED,
          capture_pageview: false,
          capture_pageleave: false,
          disable_session_recording: true,
          persistence: 'localStorage',
        });

        ph.opt_in_capturing();
        window.posthog = ph;
        setDistinctId(ph);
        log('PostHog initialized', { host: POSTHOG_HOST });

        ph.register_once({ landing_path: window.location.pathname });
        if (document.referrer) {
          ph.register_once({ landing_referrer: document.referrer });
        }

        const utms = getUtmParams();
        if (Object.keys(utms).length) {
          ph.register(utms);
          ph.register_once(withPrefix('first_touch_', utms));
          ph.people.set(utms);
          ph.people.set_once(withPrefix('first_touch_', utms));
        }

        ph.capture('page_view', {
          path: window.location.pathname,
          title: document.title,
          referrer: document.referrer,
        });

        const listNodes = document.querySelectorAll('[data-analytics-list]');
        listNodes.forEach((listNode) => {
          ph.capture('content_list_view', {
            list: listNode.getAttribute('data-analytics-list'),
          });
        });

        const contentNode = document.querySelector('[data-analytics-content]');
        if (contentNode) {
          ph.capture('content_view', {
            type: contentNode.getAttribute('data-analytics-content'),
            slug: contentNode.getAttribute('data-analytics-slug'),
            title: contentNode.getAttribute('data-analytics-title'),
          });

          const article = contentNode;
          let engaged = false;
          let completed = false;
          const handler = () => {
            const rect = article.getBoundingClientRect();
            const height = rect.height || 1;
            const progress = Math.min(Math.max((window.innerHeight - rect.top) / height, 0), 1);
            if (!engaged && progress >= 0.5) {
              engaged = true;
              ph.capture('content_engaged', {
                type: contentNode.getAttribute('data-analytics-content'),
                slug: contentNode.getAttribute('data-analytics-slug'),
                title: contentNode.getAttribute('data-analytics-title'),
                scroll: '50',
              });
            }
            if (!completed && progress >= 0.9) {
              completed = true;
              ph.capture('content_completed', {
                type: contentNode.getAttribute('data-analytics-content'),
                slug: contentNode.getAttribute('data-analytics-slug'),
                title: contentNode.getAttribute('data-analytics-title'),
                scroll: '90',
              });
            }
            if (engaged && completed) {
              window.removeEventListener('scroll', handler);
            }
          };
          window.addEventListener('scroll', handler, { passive: true });
          handler();
        }

        document.addEventListener('click', (event) => {
          const target = event.target;
          if (!(target instanceof Element)) return;

          const analyticsNode = target.closest('[data-analytics]');
          if (analyticsNode) {
            const type = analyticsNode.getAttribute('data-analytics');
            const label = analyticsNode.getAttribute('data-label') ?? analyticsNode.textContent?.trim();
            if (type === 'cta') {
              ph.capture('cta_click', { label, href: analyticsNode.getAttribute('href') });
            }
            if (type === 'nav') {
              ph.capture('nav_click', { label, href: analyticsNode.getAttribute('href') });
            }
            if (type === 'email') {
              ph.capture('contact_email_click', { href: analyticsNode.getAttribute('href') });
            }
            if (type === 'project-link') {
              ph.capture('project_link_click', { label, href: analyticsNode.getAttribute('href') });
            }
            if (type === 'project-video') {
              ph.capture('project_video_play', {
                label,
                href: analyticsNode.getAttribute('href'),
                ...getContentContext(analyticsNode),
              });
            }
          }

          const anchor = target.closest('a');
          if (anchor && anchor.hostname && anchor.hostname !== window.location.hostname) {
            ph.capture('outbound_link_click', {
              href: anchor.href,
              label: anchor.textContent?.trim(),
            });
          }
        });

        const form = document.querySelector('[data-analytics-form="contact"]');
        if (form instanceof HTMLFormElement) {
          const formName = form.getAttribute('data-analytics-form') ?? 'contact';
          let started = false;
          form.addEventListener('focusin', () => {
            if (started) return;
            started = true;
            ph.capture('contact_form_start', { form: formName });
          });
          form.addEventListener('submit', () => {
            ph.capture('contact_form_submit', { form: formName });
          });
        }

        const videoNodes = document.querySelectorAll('[data-analytics-video]');
        videoNodes.forEach((node) => {
          if (!(node instanceof HTMLVideoElement)) return;
          const type = node.getAttribute('data-analytics-video');
          node.addEventListener(
            'play',
            () => {
              ph.capture('project_video_play', { type, ...getContentContext(node) });
            },
            { once: true }
          );
        });

        const allowReplay =
          SESSION_REPLAY_ENABLED && document.body.getAttribute('data-session-replay') === 'true';
        if (allowReplay) {
          ph.startSessionRecording?.();
        } else {
          ph.stopSessionRecording?.();
        }
        ph.register({ session_replay_enabled: allowReplay });
      } catch (err) {
        log('Error initializing PostHog', err);
      }
    };

    initPosthog();
  </script>
) : null}
