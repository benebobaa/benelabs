---
import BaseLayout from '../../layouts/BaseLayout.astro';
import TagList from '../../components/TagList.astro';
import { formatDate } from '../../lib/format';
import { getProjects } from '../../lib/sanity';

export async function getStaticPaths() {
  const projects = await getProjects();
  return projects.map((project) => ({
    params: { slug: project.slug },
    props: { project },
  }));
}

const { project } = Astro.props;
const description = project.seo?.description ?? project.summary ?? `Case study: ${project.title}.`;
const content = project.content ?? '<p>Full case study coming soon.</p>';
const siteUrl = Astro.site ?? 'https://Benelabs.tech';
const pageUrl = new URL(`/projects/${project.slug}`, siteUrl).toString();
const fallbackImage = new URL('/og/default.svg', siteUrl).toString();
const imageUrl = project.coverImage?.url ?? fallbackImage;
const normalizeDate = (value) => {
  if (!value) return undefined;
  const date = new Date(value);
  return Number.isNaN(date.getTime()) ? undefined : date.toISOString();
};
const publishedTime = normalizeDate(project.publishedAt);
const keywords = (project.techStack ?? []).filter(Boolean).join(', ');
const projectLd = {
  '@context': 'https://schema.org',
  '@type': 'SoftwareApplication',
  name: project.title,
  description,
  url: pageUrl,
  image: imageUrl,
  applicationCategory: 'BusinessApplication',
  operatingSystem: 'Web',
  ...(keywords ? { keywords } : {}),
  ...(publishedTime ? { datePublished: publishedTime } : {}),
  author: {
    '@type': 'Organization',
    name: 'Benelabs',
    url: siteUrl,
  },
  publisher: {
    '@type': 'Organization',
    name: 'Benelabs',
    url: siteUrl,
  },
};

const getYouTubeId = (url) => {
  try {
    const parsed = new URL(url);
    if (parsed.hostname === 'youtu.be') return parsed.pathname.slice(1) || null;
    if (parsed.hostname.includes('youtube.com')) {
      const id = parsed.searchParams.get('v');
      if (id) return id;
      const parts = parsed.pathname.split('/');
      const embedIndex = parts.indexOf('embed');
      if (embedIndex !== -1 && parts[embedIndex + 1]) return parts[embedIndex + 1];
    }
  } catch {
    return null;
  }
  return null;
};

const getVimeoId = (url) => {
  try {
    const parsed = new URL(url);
    if (!parsed.hostname.includes('vimeo.com')) return null;
    const parts = parsed.pathname.split('/').filter(Boolean);
    const id = parts[0];
    return id && /^[0-9]+$/.test(id) ? id : null;
  } catch {
    return null;
  }
};

const demoVideo = project.demoVideo;
const youtubeId = demoVideo?.url ? getYouTubeId(demoVideo.url) : null;
const vimeoId = demoVideo?.url ? getVimeoId(demoVideo.url) : null;
const videoEmbed = demoVideo?.url
  ? youtubeId
    ? { type: 'youtube', src: `https://www.youtube.com/embed/${youtubeId}` }
    : vimeoId
      ? { type: 'vimeo', src: `https://player.vimeo.com/video/${vimeoId}` }
      : { type: 'file', src: demoVideo.url }
  : null;
---

<BaseLayout
  title={`${project.seo?.title ?? project.title} | Benelabs`}
  description={description}
  ogType="article"
  ogImage={imageUrl}
  ogImageAlt={project.coverImage?.alt ?? project.title}
  publishedTime={publishedTime}
  structuredData={projectLd}
>
  <article
    class="site-container section-block"
    data-analytics-content="project"
    data-analytics-slug={project.slug}
    data-analytics-title={project.title}
  >
    <div class="mx-auto max-w-[var(--content-narrow)] space-y-6">
      <div class="space-y-4">
        <a class="eyebrow inline-flex min-h-[44px] items-center" href="/projects">Back to projects</a>
        <h1 class="text-[1.8rem] md:text-4xl">{project.title}</h1>
        <p class="text-base text-[var(--color-ink-muted)] md:text-lg">{project.summary}</p>
        <div class="flex flex-wrap items-center gap-3 text-xs text-[var(--color-ink-subtle)]">
          <span>{formatDate(project.publishedAt)}</span>
          <TagList tags={project.techStack ?? []} />
        </div>
      </div>
      {project.coverImage ? (
        <img
          class="card-surface h-64 w-full object-cover"
          src={project.coverImage.url}
          alt={project.coverImage.alt ?? project.title}
          width={project.coverImage.width}
          height={project.coverImage.height}
          sizes="(min-width: 768px) 760px, 100vw"
          loading="lazy"
          decoding="async"
        />
      ) : null}
      {demoVideo?.url ? (
        <div class="card-surface card-pad space-y-3">
          <div class="eyebrow">Demo video</div>
          {videoEmbed?.type === 'file' ? (
            <video
              class="w-full rounded-[var(--radius-md)]"
              src={videoEmbed.src}
              poster={demoVideo.poster?.url}
              controls
              playsinline
              preload="metadata"
            />
          ) : videoEmbed ? (
            <div class="relative w-full overflow-hidden rounded-[var(--radius-md)] bg-[var(--color-warm)] pb-[56.25%]">
              <iframe
                class="absolute inset-0 h-full w-full"
                src={videoEmbed.src}
                title={demoVideo.title ?? `${project.title} demo video`}
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
              ></iframe>
            </div>
          ) : (
            <a
              class="inline-flex min-h-[44px] items-center text-sm font-semibold text-[var(--color-accent)]"
              href={demoVideo.url}
              target="_blank"
              rel="noopener noreferrer"
            >
              Watch demo video ->
            </a>
          )}
          {demoVideo.caption ? (
            <p class="text-sm text-[var(--color-ink-muted)]">{demoVideo.caption}</p>
          ) : null}
        </div>
      ) : null}
      <div class="prose max-w-none" set:html={content} />
      {project.links?.length ? (
        <div class="card-surface card-pad space-y-3">
          <div class="eyebrow">Project links</div>
          <div class="flex flex-col gap-2 text-sm text-[var(--color-ink-muted)]">
            {project.links.map((link) => (
              <a
                class="inline-flex min-h-[44px] items-center hover:text-[var(--color-accent)]"
                href={link.url}
                data-analytics="project-link"
                data-label={link.label}
              >
                {link.label} ->
              </a>
            ))}
          </div>
        </div>
      ) : null}
    </div>
  </article>
</BaseLayout>
